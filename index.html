<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>故事接龍 — 多人即時遊戲</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;700;900&family=Noto+Sans+TC:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<!-- ══ HOME ═══════════════════════════════════════════════ -->
<div id="screen-home" class="screen active">
  <div class="bg-noise"></div>
  <div class="container">
    <div class="hero">
      <div class="hero-glyph">故</div>
      <h1 class="logo">故事接龍</h1>
      <p class="subtitle">多人即時協作敘事遊戲</p>
    </div>
    <div class="card">
      <div class="form-group">
        <label for="input-name">你的暱稱</label>
        <input type="text" id="input-name" placeholder="輸入暱稱…" maxlength="20" autocomplete="off">
      </div>
      <div class="btn-group-vert">
        <button id="btn-create-room" class="btn btn-primary btn-full">✦ 建立房間</button>
        <div class="divider"><span>或加入現有房間</span></div>
        <div class="join-row">
          <input type="text" id="input-room-code" placeholder="輸入房間代碼" maxlength="6" autocomplete="off">
          <button id="btn-join-room" class="btn btn-secondary">加入</button>
        </div>
      </div>
    </div>
    <div id="home-error" class="error-msg hidden"></div>
  </div>
</div>

<!-- ══ ROOM ════════════════════════════════════════════════ -->
<div id="screen-room" class="screen hidden">
  <div class="bg-noise"></div>
  <div class="container wide">
    <div class="room-topbar">
      <div class="room-code-wrap">
        <span class="topbar-label">房間代碼</span>
        <span id="display-room-code" class="room-code-badge">------</span>
        <button id="btn-copy-code" class="btn-icon" title="複製代碼">📋</button>
      </div>
      <button id="btn-leave-room" class="btn btn-ghost btn-sm">← 離開</button>
    </div>
    <div class="room-body">
      <div class="panel players-panel">
        <div class="panel-header">
          玩家列表
          <span id="player-count" class="badge-count">0 / 8</span>
        </div>
        <ul id="players-list" class="players-list"></ul>
      </div>
      <div class="panel settings-panel hidden" id="settings-panel">
        <div class="panel-header">遊戲設定 <span class="host-crown">👑 主持人</span></div>
        <div class="form-group">
          <label>遊戲模式</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="game-mode" value="round" checked>
              <span class="radio-box"></span>回合制（全員鎖定後換輪）
            </label>
            <label class="radio-label">
              <input type="radio" name="game-mode" value="time">
              <span class="radio-box"></span>計時制（倒數結束自動換輪）
            </label>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group half">
            <label for="input-rounds">回合數</label>
            <input type="number" id="input-rounds" value="2" min="1" max="10">
          </div>
          <div class="form-group half hidden" id="time-setting">
            <label for="input-turn-time">每輪秒數</label>
            <input type="number" id="input-turn-time" value="90" min="15" max="300">
          </div>
        </div>
        <p class="round-hint">一回合 = 每位玩家輪流寫完所有故事一遍</p>
        <button id="btn-start-game" class="btn btn-primary btn-full">開始遊戲 →</button>
        <div id="room-error" class="error-msg hidden"></div>
      </div>
      <div class="panel waiting-panel hidden" id="waiting-panel">
        <div class="spinner large"></div>
        <p class="waiting-text">等待主持人開始遊戲</p>
        <p class="waiting-hint">遊戲設定由主持人決定</p>
      </div>
    </div>
  </div>
</div>

<!-- ══ GAME ════════════════════════════════════════════════ -->
<div id="screen-game" class="screen hidden">
  <div class="bg-noise"></div>
  <div class="game-wrap">

    <!-- Header (always visible inside game screen) -->
    <div class="game-header">
      <div class="game-meta">
        <span id="game-round-label" class="round-label">第 1 回合</span>
        <span id="game-turn-label"  class="turn-label">第 1 / 1 輪</span>
        <span id="game-phase-badge" class="phase-badge writing">寫作中</span>
      </div>
      <div id="game-timer" class="game-timer hidden">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span id="timer-value">90</span>
      </div>
      <div id="header-lock-info" class="lock-info">
        <span id="lock-count">已鎖定 0 / 0</span>
      </div>
    </div>

    <!-- ── WRITING ── -->
    <div id="phase-writing" class="game-phase hidden">
      <div class="context-section">
        <div class="section-label">📜 上一段故事</div>
        <div id="story-context-text" class="context-box">
          <span class="context-placeholder">（故事的開端，由你來書寫！）</span>
        </div>
      </div>
      <div class="writing-section">
        <div class="section-label">✍️ 你的接龍</div>
        <textarea id="story-input"
          placeholder="繼續這個故事… （Enter 鎖定，Shift+Enter 換行）"
          rows="6" maxlength="500"></textarea>
        <div class="writing-footer">
          <span id="char-count" class="char-counter">0 / 500</span>
          <div class="writing-actions">
            <button id="btn-unlock" class="btn btn-ghost hidden">🔓 解鎖修改</button>
            <button id="btn-lock"   class="btn btn-primary">🔒 鎖定答案</button>
          </div>
        </div>
      </div>
      <div id="waiting-locked" class="waiting-locked hidden">
        <div class="spinner"></div>
        <span>已鎖定，等待其他玩家完成…</span>
      </div>
    </div>

    <!-- ── SPECTATING (mid-game joiners during WRITING phase) ── -->
    <div id="phase-spectating" class="game-phase hidden">
      <div class="spec-hero">
        <div class="spec-glyph">👀</div>
        <h2 class="spec-title">觀戰模式</h2>
        <p class="spec-desc">你在遊戲進行中加入，本局以旁觀者身份參與<br>遊戲結束後將自動加入下一局！</p>
      </div>
      <div class="spec-status-card">
        <div class="spec-status-row">
          <span id="spec-round" class="spec-round-label">－</span>
          <span id="spec-lock-status" class="spec-lock-badge">0 / 0 人已鎖定</span>
        </div>
        <div id="spec-players-grid" class="spec-players-grid"></div>
      </div>
      <div class="spec-waiting">
        <div class="spinner"></div>
        <span>等待本輪結束…</span>
      </div>
    </div>

    <!-- ── REVEALING ── -->
    <div id="phase-revealing" class="game-phase hidden">
      <div class="reveal-hero-section">
        <div class="reveal-glyph">謎</div>
        <h2 class="reveal-title">故事揭示時刻</h2>
        <p id="reveal-subtitle" class="reveal-subtitle">主持人將逐段揭示眾人合力創作的故事</p>
      </div>
      <div class="reveal-progress-bar">
        <div id="reveal-progress-fill" class="reveal-progress-fill" style="width:0%"></div>
      </div>
      <div id="reveal-stories-container" class="reveal-stories-container"></div>
      <div class="reveal-footer">
        <button id="btn-reveal-next"       class="btn btn-primary hidden">▶&ensp;揭示下一段</button>
        <p      id="reveal-watching-text"  class="reveal-watching hidden">✦ 等待主持人揭示故事…</p>
        <button id="btn-reveal-done"       class="btn btn-accent  hidden">✦ 查看完整故事</button>
      </div>
    </div>

    <!-- ── FINISHED ── -->
    <div id="phase-finished" class="game-phase hidden">
      <div class="finished-header">
        <div class="finished-glyph">終</div>
        <h2>完整故事大公開</h2>
        <p class="finished-subtitle">每一則故事都是大家共同的傑作</p>
      </div>
      <div id="final-stories" class="final-stories"></div>
      <div class="finished-footer">
        <button id="btn-back-to-lobby" class="btn btn-ghost">← 返回房間大廳</button>
      </div>
    </div>

  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden"></div>

<!-- Overlay -->
<div id="overlay" class="overlay hidden">
  <div class="overlay-content">
    <div class="spinner large"></div>
    <p id="overlay-msg">連接中…</p>
  </div>
</div>

<script src="main.js"></script>
</body>
</html>
